<!doctype html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <style>
      * {
        padding: 0;
        margin: 0;
      }
      html,
      body {
        overflow: hidden;
      }
      canvas {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        outline: none;
      }
      .logo {
        position: fixed;
        width: 320px;
        height: auto;
        left: 20px;
        bottom: 20px;
      }
    </style>
  </head>
  <body>
    <canvas id="canvas"></canvas>
    <img
      src="../images/kotlin-fest-2024/Logo_Landscape_DarkBG.svg"
      alt="Kotlin Fest 2024"
      width="399"
      height="79"
      class="logo"
    />

    <script type="module">
      const canvas = document.getElementById('canvas');
      const ctx = canvas.getContext('2d', { willReadFrequently: true });

      let dpr = window.devicePixelRatio;

      function resizeCanvasToFitDisplaySize() {
        canvas.width = Math.round(canvas.clientWidth * dpr);
        canvas.height = Math.round(canvas.clientHeight * dpr);
      }

      window.addEventListener('resize', resizeCanvasToFitDisplaySize);
      resizeCanvasToFitDisplaySize();

      let molds = [];
      for (let i = 0; i < 2000; i += 1) {
        const m = createMold();
        molds.push(m);
      }

      let pixels;

      (function loop() {
        requestAnimationFrame(loop);

        dpr = window.devicePixelRatio;

        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
        pixels = imageData.data;

        ctx.fillStyle = '#00000008';
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        for (const m of molds) {
          updateMold(m);
          displayMold(m);
        }
      })();

      function displayMold(mold) {
        const {
          position: { x, y },
          radius
        } = mold;

        ctx.beginPath();
        ctx.fillStyle = '#ffffff88';
        ctx.arc(x, y, radius, 0, 2 * Math.PI, true);
        ctx.fill();
      }

      function createMold() {
        const x = Math.random() * canvas.width;
        const y = Math.random() * canvas.height;
        const radius = 1.0;
        const heading = Math.random() * Math.PI * 2.0;
        const rotAngle = Math.PI / 4;

        const sensor = {
          rightPosition: { x: 0.0, y: 0.0 },
          leftPosition: { x: 0.0, y: 0.0 },
          forwardPosition: { x: 0.0, y: 0.0 },
          angle: Math.PI / 4,
          distance: 10
        };

        return {
          position: { x, y },
          velocity: {
            x: Math.cos(heading),
            y: Math.sin(heading)
          },
          radius,
          heading,
          rotAngle,
          sensor
        };
      }

      function updateMold(mold) {
        const width = canvas.width;
        const height = canvas.height;

        const dt = 1.0;

        // Move
        const nextVX = Math.cos(mold.heading);
        const nextVY = Math.sin(mold.heading);

        let nextX = mold.position.x + nextVX * dt;
        let nextY = mold.position.y + nextVY * dt;

        nextX = (nextX + width) % width;
        nextY = (nextY + height) % height;

        mold.velocity.x = nextVX;
        mold.velocity.y = nextVY;
        mold.position.x = nextX;
        mold.position.y = nextY;

        // sensor position
        updateSensorPositions(mold);

        const rSens = mold.sensor.rightPosition;
        const lSens = mold.sensor.leftPosition;
        const fSens = mold.sensor.forwardPosition;

        const rVal = pixels[getPixelIndex(rSens)];
        const lVal = pixels[getPixelIndex(lSens)];
        const fVal = pixels[getPixelIndex(fSens)];

        if (fVal > lVal && fVal > rVal) {
          // do nothing
        } else if (fVal < lVal && fVal < rVal) {
          const sig = Math.random() < 0.5 ? 1 : -1;
          mold.heading += sig * mold.rotAngle;
        } else if (lVal > rVal) {
          mold.heading -= mold.rotAngle;
        } else if (rVal > lVal) {
          mold.heading += mold.rotAngle;
        }
      }

      function getPixelIndex(vector) {
        const px = Math.floor(vector.x);
        const py = Math.floor(vector.y);
        return 4 * (dpr * py) * (dpr * canvas.clientWidth) + 4 * (dpr * px);
      }

      function updateSensorPositions(mold) {
        const {
          sensor,
          position: { x, y },
          heading
        } = mold;
        const a = sensor.angle;
        const d = sensor.distance;

        const width = canvas.clientWidth;
        const height = canvas.clientHeight;

        // right
        const rpx = x + d * Math.cos(heading + a);
        const rpy = y + d * Math.sin(heading + a);
        sensor.rightPosition.x = (rpx + width) % width;
        sensor.rightPosition.y = (rpy + height) % height;

        // left
        const lpx = x + d * Math.cos(heading - a);
        const lpy = y + d * Math.sin(heading - a);
        sensor.leftPosition.x = (lpx + width) % width;
        sensor.leftPosition.y = (lpy + height) % height;

        // forward
        const fpx = x + d * Math.cos(heading);
        const fpy = y + d * Math.sin(heading);
        sensor.forwardPosition.x = (fpx + width) % width;
        sensor.forwardPosition.y = (fpy + height) % height;
      }
    </script>
  </body>
</html>
